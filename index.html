<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Motor + Sensors + Relay Control</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
  h1 { text-align: center; }
  .section { margin-bottom: 30px; }
  label { display: block; margin: 10px 0 5px; }
  button { margin-top: 10px; }
  .relay-btn { width: 60px; height: 30px; margin-right: 10px; }
  #motorPercent, #rainStatus, #waterLevel { font-weight: bold; }
</style>
</head>
<body>

<h1>Motor + Sensors + Relay Control</h1>

<div class="section" id="motorControl">
  <h2>Motor Control</h2>
  <label for="targetPercent">Target Position (%): <span id="targetPercentValue">0</span>%</label>
  <input type="range" id="targetPercent" min="0" max="100" value="0" />
  <p>Current Position: <span id="motorPercent">0</span>%</p>
  <p>Motor State: <span id="motorState">stopped</span></p>
</div>

<div class="section" id="sensorStatus">
  <h2>Sensor Status</h2>
  <p>Rain Sensor: <span id="rainStatus">No Rain</span></p>
  <p>Water Level: <span id="waterLevel">0</span>%</p>
</div>

<div class="section" id="relayControl">
  <h2>Relay Control (4 Channels)</h2>
  <div>
    <button class="relay-btn" data-ch="1" data-state="off">Relay 1 OFF</button>
    <button class="relay-btn" data-ch="2" data-state="off">Relay 2 OFF</button>
    <button class="relay-btn" data-ch="3" data-state="off">Relay 3 OFF</button>
    <button class="relay-btn" data-ch="4" data-state="off">Relay 4 OFF</button>
  </div>
</div>

<script>
  // MQTT broker connection info
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt'; // WebSocket + TLS
  const options = {
    username: 'tohits',
    password: 'toh123@TOH',
    reconnectPeriod: 1000,
    clean: true,
    connectTimeout: 4000,
  };

  // Topics
  const topicTarget = 'motor/targetPercent';
  const topicPercent = 'motor/percent';
  const topicState = 'motor/state';
  const topicRain = 'sensor/rain';
  const topicWaterLevel = 'sensor/waterLevel';
  const topicRelay = 'relay/control';

  // Connect MQTT client
  const client = mqtt.connect(broker, options);

  client.on('connect', () => {
    console.log('Connected to MQTT broker');
    // Subscribe to status topics
    client.subscribe([topicPercent, topicState, topicRain, topicWaterLevel]);
  });

  client.on('message', (topic, message) => {
    const msg = message.toString();
    if (topic === topicPercent) {
      document.getElementById('motorPercent').textContent = msg;
    } else if (topic === topicState) {
      document.getElementById('motorState').textContent = msg;
    } else if (topic === topicRain) {
      document.getElementById('rainStatus').textContent = (msg === '1') ? 'Raining' : 'No Rain';
    } else if (topic === topicWaterLevel) {
      document.getElementById('waterLevel').textContent = msg;
    }
  });

  // Motor control slider
  const targetPercentSlider = document.getElementById('targetPercent');
  const targetPercentValue = document.getElementById('targetPercentValue');

  targetPercentSlider.addEventListener('input', () => {
    targetPercentValue.textContent = targetPercentSlider.value;
  });

  targetPercentSlider.addEventListener('change', () => {
    const val = parseInt(targetPercentSlider.value);
    client.publish(topicTarget, val.toString());
  });

  // Relay buttons control
  const relayButtons = document.querySelectorAll('.relay-btn');
  relayButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const ch = btn.getAttribute('data-ch');
      const currentState = btn.getAttribute('data-state') === 'on';
      const newState = !currentState;

      // Update button appearance
      btn.setAttribute('data-state', newState ? 'on' : 'off');
      btn.textContent = `Relay ${ch} ${newState ? 'ON' : 'OFF'}`;
      btn.style.backgroundColor = newState ? '#4CAF50' : '';

      // Send JSON command via MQTT
      const command = JSON.stringify({ ch: parseInt(ch), on: newState });
      client.publish(topicRelay, command);
    });
  });
</script>

</body>
</html>
