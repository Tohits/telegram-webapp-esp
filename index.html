<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Motor & Relay Control</title>

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f9;
    color: #333;
  }
  h2 { margin-top: 30px; }
  p { font-size: 22px; }
  button {
    width: 120px;
    height: 50px;
    font-size: 18px;
    margin: 5px;
    border: none;
    border-radius: 12px;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px #666;
  }
  button:active {
    box-shadow: 0 2px #666;
    transform: translateY(4px);
  }
  .on { background: limegreen; }
  .off { background: tomato; }
  .idle { background: gray; }
  hr { margin: 30px 0; }
</style>
</head>

<body>

<h2>Motor Control</h2>
<p>Status: <b id="motorStatus">OFF</b></p>
<button id="motorOn" class="idle" onclick="sendCommand('motor/control','ON')">ON</button>
<button id="motorOff" class="idle" onclick="sendCommand('motor/control','OFF')">OFF</button>

<hr>

<h2>Relay Controls</h2>

<div>
  <p>Relay 1 (D2) Status: <b id="r1Status">OFF</b></p>
  <button id="r1On" class="idle" onclick="sendCommand('relay/1','ON')">ON</button>
  <button id="r1Off" class="idle" onclick="sendCommand('relay/1','OFF')">OFF</button>
</div>

<div>
  <p>Relay 2 (D3) Status: <b id="r2Status">OFF</b></p>
  <button id="r2On" class="idle" onclick="sendCommand('relay/2','ON')">ON</button>
  <button id="r2Off" class="idle" onclick="sendCommand('relay/2','OFF')">OFF</button>
</div>

<div>
  <p>Relay 3 (D4) Status: <b id="r3Status">OFF</b></p>
  <button id="r3On" class="idle" onclick="sendCommand('relay/3','ON')">ON</button>
  <button id="r3Off" class="idle" onclick="sendCommand('relay/3','OFF')">OFF</button>
</div>

<div>
  <p>Relay 4 (D7) Status: <b id="r4Status">OFF</b></p>
  <button id="r4On" class="idle" onclick="sendCommand('relay/4','ON')">ON</button>
  <button id="r4Off" class="idle" onclick="sendCommand('relay/4','OFF')">OFF</button>
</div>

<hr>

<h2>Water Level</h2>
<p><b id="waterLevel">--%</b></p>

<p>MQTT Status: <b id="mqttStatus">Disconnected</b></p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';
const options = { username: 'tohits', password: 'toh123@TOH', reconnectPeriod: 1000 };
const client = mqtt.connect(broker, options);

// DOM Elements
const mqttStatus = document.getElementById('mqttStatus');

// Motor
const motorStatus = document.getElementById('motorStatus');
const motorOn = document.getElementById('motorOn');
const motorOff = document.getElementById('motorOff');

// Relays
const relays = [
  { status: document.getElementById('r1Status'), on: document.getElementById('r1On'), off: document.getElementById('r1Off'), topic: 'relay/1' },
  { status: document.getElementById('r2Status'), on: document.getElementById('r2On'), off: document.getElementById('r2Off'), topic: 'relay/2' },
  { status: document.getElementById('r3Status'), on: document.getElementById('r3On'), off: document.getElementById('r3Off'), topic: 'relay/3' },
  { status: document.getElementById('r4Status'), on: document.getElementById('r4On'), off: document.getElementById('r4Off'), topic: 'relay/4' },
];

// Water
const waterLevelEl = document.getElementById('waterLevel');

// Send command
function sendCommand(topic, msg) {
  if(client.connected) client.publish(topic,msg);
  else alert("MQTT not connected");
}

// Update buttons & status
function updateStatus(elStatus, elOn, elOff, status) {
  elStatus.innerText = status;
  if(status==='ON'){ elOn.className='on'; elOff.className='idle'; }
  else if(status==='OFF'){ elOn.className='idle'; elOff.className='off'; }
  else{ elOn.className='idle'; elOff.className='idle'; }
}

// MQTT Events
client.on('connect', () => {
  mqttStatus.innerText = 'Connected'; mqttStatus.style.color='green';
  client.subscribe('motor/status');
  client.subscribe('relay/1');
  client.subscribe('relay/2');
  client.subscribe('relay/3');
  client.subscribe('relay/4');
  client.subscribe('sensor/waterLevel');
});

client.on('offline',()=>{ mqttStatus.innerText='Offline'; mqttStatus.style.color='red'; });

client.on('message', (topic,message)=>{
  const msg = message.toString();
  if(topic==='motor/status'){ updateStatus(motorStatus,motorOn,motorOff,msg); }
  else if(topic==='sensor/waterLevel'){ waterLevelEl.innerText = msg + '%'; }
  else{
    for(let r of relays){
      if(topic===r.topic){ updateStatus(r.status,r.on,r.off,msg); }
    }
  }
});
</script>
</body>
</html>
