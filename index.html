<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3-Phase Motor & 4-Relay Control with MQTT</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f9;
    color: #333;
  }
  h2 {
    margin-top: 30px;
  }
  p {
    font-size: 20px;
  }
  button {
    width: 120px;
    height: 50px;
    font-size: 18px;
    margin: 10px;
    border: none;
    border-radius: 12px;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px #666;
    transition: 0.2s;
  }
  button:active {
    box-shadow: 0 2px #666;
    transform: translateY(2px);
  }
  #onBtn, #offBtn, .relay-on, .relay-off { background: gray; }

  .relay-container {
    margin-top: 25px;
    border-top: 1px solid #ccc;
    padding-top: 15px;
  }

  #mqttStatus {
    font-weight: bold;
    font-size: 18px;
  }
</style>
</head>
<body>

<h2>3-Phase Motor Control</h2>
<p>Motor Status: <b id="motorStatus">OFF</b></p>
<button id="onBtn" onclick="sendMotorCommand('ON')">ON</button>
<button id="offBtn" onclick="sendMotorCommand('OFF')">OFF</button>

<div class="relay-container">
  <h2>Extra Relays Control</h2>

  <div>
    <p>Relay 1 Status: <b id="relay1Status">OFF</b></p>
    <button class="relay-on" onclick="sendRelayCommand(1,'ON')">ON</button>
    <button class="relay-off" onclick="sendRelayCommand(1,'OFF')">OFF</button>
  </div>

  <div>
    <p>Relay 2 Status: <b id="relay2Status">OFF</b></p>
    <button class="relay-on" onclick="sendRelayCommand(2,'ON')">ON</button>
    <button class="relay-off" onclick="sendRelayCommand(2,'OFF')">OFF</button>
  </div>

  <div>
    <p>Relay 3 Status: <b id="relay3Status">OFF</b></p>
    <button class="relay-on" onclick="sendRelayCommand(3,'ON')">ON</button>
    <button class="relay-off" onclick="sendRelayCommand(3,'OFF')">OFF</button>
  </div>

  <div>
    <p>Relay 4 Status: <b id="relay4Status">OFF</b></p>
    <button class="relay-on" onclick="sendRelayCommand(4,'ON')">ON</button>
    <button class="relay-off" onclick="sendRelayCommand(4,'OFF')">OFF</button>
  </div>
</div>

<p>MQTT Status: <span id="mqttStatus">Disconnected</span></p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  // HiveMQ Cloud MQTT broker WSS URL
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';

  const options = {
    username: 'tohits',
    password: 'toh123@TOH',
    reconnectPeriod: 1000,
    clean: true,
    connectTimeout: 4000,
  };

  const client = mqtt.connect(broker, options);

  const motorStatusEl = document.getElementById('motorStatus');
  const mqttStatusEl = document.getElementById('mqttStatus');

  const relayStatusEls = [
    document.getElementById('relay1Status'),
    document.getElementById('relay2Status'),
    document.getElementById('relay3Status'),
    document.getElementById('relay4Status')
  ];

  // Update motor buttons
  const onBtn = document.getElementById('onBtn');
  const offBtn = document.getElementById('offBtn');
  function updateMotorButtonColors(status) {
    if(status === 'ON') {
      motorStatusEl.innerText = 'ON';
      onBtn.style.background = 'limegreen';
      offBtn.style.background = 'gray';
    } else {
      motorStatusEl.innerText = 'OFF';
      offBtn.style.background = 'tomato';
      onBtn.style.background = 'gray';
    }
  }

  // Update relay buttons
  function updateRelayStatus(relay, status) {
    relayStatusEls[relay-1].innerText = status;
    const buttons = relayStatusEls[relay-1].parentNode.querySelectorAll('button');
    if(status === 'ON') {
      buttons[0].style.background = 'limegreen';
      buttons[1].style.background = 'gray';
    } else {
      buttons[0].style.background = 'gray';
      buttons[1].style.background = 'tomato';
    }
  }

  // Send motor command
  function sendMotorCommand(cmd) {
    if(client.connected) client.publish('motor/control', cmd);
    else alert('MQTT not connected!');
  }

  // Send relay command
  function sendRelayCommand(relay, cmd) {
    if(client.connected) client.publish('relay'+relay+'/control', cmd);
    else alert('MQTT not connected!');
  }

  // MQTT events
  client.on('connect', () => {
    mqttStatusEl.innerText = 'Connected';
    mqttStatusEl.style.color = 'limegreen';

    client.subscribe('motor/status');
    for(let i=1;i<=4;i++) client.subscribe('relay'+i+'/status');
  });

  client.on('reconnect', () => {
    mqttStatusEl.innerText = 'Reconnecting...';
    mqttStatusEl.style.color = 'orange';
  });

  client.on('error', (error) => {
    mqttStatusEl.innerText = 'Error';
    mqttStatusEl.style.color = 'red';
    console.error('MQTT Error:', error);
  });

  client.on('offline', () => {
    mqttStatusEl.innerText = 'Offline';
    mqttStatusEl.style.color = 'red';
  });

  client.on('close', () => {
    mqttStatusEl.innerText = 'Disconnected';
    mqttStatusEl.style.color = 'red';
  });

  client.on('message', (topic, message) => {
    const status = message.toString();
    if(topic === 'motor/status') updateMotorButtonColors(status);
    else {
      for(let i=1;i<=4;i++){
        if(topic === 'relay'+i+'/status'){
          updateRelayStatus(i, status);
        }
      }
    }
  });

</script>
</body>
</html>
