<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Motor & Water Level Control</title>

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f9;
    color: #333;
  }
  h2 { margin-top: 25px; }

  p {
    font-size: 22px;
  }

  button {
    width: 160px;
    height: 70px;
    font-size: 22px;
    margin: 15px;
    border: none;
    border-radius: 15px;
    color: white;
    cursor: pointer;
    box-shadow: 0 5px #666;
    transition: 0.2s;
  }

  button:active {
    box-shadow: 0 2px #666;
    transform: translateY(4px);
  }

  #onBtn  { background: gray; }
  #offBtn { background: gray; }

  .green { color: limegreen; }
  .red   { color: red; }
</style>
</head>

<body>

<h2>3-Phase Motor Control</h2>

<p>Motor Status: <b id="motorStatus">OFF</b></p>
<button id="onBtn"  onclick="sendCommand('ON')">ON</button>
<button id="offBtn" onclick="sendCommand('OFF')">OFF</button>

<p>MQTT Status: <b id="mqttStatus">Disconnected</b></p>
<p>ESP WiFi Status: <b id="espStatus">Unknown</b></p>

<h2>Water Level</h2>
<p><b id="waterLevel">--%</b></p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';

  const options = {
    username: 'tohits',
    password: 'toh123@TOH',
    reconnectPeriod: 1000,
    clean: true,
    connectTimeout: 4000
  };

  const client = mqtt.connect(broker, options);

  const motorStatusEl = document.getElementById('motorStatus');
  const mqttStatusEl  = document.getElementById('mqttStatus');
  const espStatusEl   = document.getElementById('espStatus');
  const waterEl       = document.getElementById('waterLevel');
  const onBtn  = document.getElementById('onBtn');
  const offBtn = document.getElementById('offBtn');

  function updateButtonColors(status) {
    if (status === 'ON') {
      motorStatusEl.innerText = 'ON';
      onBtn.style.background = 'limegreen';
      offBtn.style.background = 'gray';
    } else {
      motorStatusEl.innerText = 'OFF';
      offBtn.style.background = 'tomato';
      onBtn.style.background = 'gray';
    }
  }

  function sendCommand(cmd) {
    if (client.connected) {
      client.publish('motor/control', cmd);
    }
  }

  client.on('connect', () => {
    mqttStatusEl.innerText = 'Connected';
    mqttStatusEl.className = 'green';

    client.subscribe('motor/status');
    client.subscribe('sensor/waterLevel');
    client.subscribe('esp/status');
  });

  client.on('offline', () => {
    mqttStatusEl.innerText = 'Offline';
    mqttStatusEl.className = 'red';
  });

  client.on('message', (topic, message) => {
    const msg = message.toString();

    if (topic === 'motor/status') {
      updateButtonColors(msg);
    }

    if (topic === 'sensor/waterLevel') {
      let value = parseInt(msg);
      if (isNaN(value)) return;

      if (value < 0) value = 0;
      if (value > 100) value = 100;

      waterEl.innerText = value + '%';
    }

    if (topic === 'esp/status') {
      if (msg === 'ONLINE') {
        espStatusEl.innerText = 'Connected';
        espStatusEl.className = 'green';
      } else {
        espStatusEl.innerText = 'Disconnected';
        espStatusEl.className = 'red';
      }
    }
  });
</script>

</body>
</html>
