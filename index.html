<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3-Phase Motor Control Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f9;
    color: #333;
  }
  h2 { margin-top: 20px; }
  p { font-size: 20px; }
  button {
    width: 170px;
    height: 65px;
    font-size: 22px;
    margin: 10px;
    border: none;
    border-radius: 15px;
    color: white;
    cursor: pointer;
    box-shadow: 0 5px #666;
    transition: 0.2s;
  }
  button:active {
    box-shadow: 0 2px #666;
    transform: translateY(4px);
  }
  #onBtn { background: gray; }
  #offBtn { background: gray; }
  #resetBtn { background: #444; }

  .online { color: limegreen; font-weight: bold; }
  .offline { color: red; font-weight: bold; }

  .water-box {
    width: 260px;
    margin: 15px auto;
    background: #ddd;
    border-radius: 15px;
    overflow: hidden;
  }
  .water-level {
    height: 30px;
    background: #2196f3;
    width: 0%;
    color: white;
    font-weight: bold;
    line-height: 30px;
  }
</style>
</head>
<body>

<h2>3-Phase Motor Control</h2>

<p>Motor Status: <b id="motorStatus">--</b></p>
<button id="onBtn" onclick="sendCommand('ON')">ON</button>
<button id="offBtn" onclick="sendCommand('OFF')">OFF</button>

<hr>

<p>ESP Status: <span id="espStatus" class="offline">OFFLINE</span></p>
<p>ESP IP: <b id="espIP">--</b></p>
<p>ESP Uptime: <b id="espUptime">--:--:--</b></p>

<p>Water Level:</p>
<div class="water-box">
  <div id="waterLevelBar" class="water-level">0%</div>
</div>

<button id="resetBtn" onclick="resetESP()">RESET ESP</button>

<p>MQTT Status: <span id="mqttStatus">Disconnected</span></p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';
  const options = {
    username: 'tohits',
    password: 'toh123@TOH',
    reconnectPeriod: 1000,
    clean: true,
    connectTimeout: 4000,
  };

  const client = mqtt.connect(broker, options);

  const motorStatusEl = document.getElementById('motorStatus');
  const mqttStatusEl  = document.getElementById('mqttStatus');
  const espStatusEl   = document.getElementById('espStatus');
  const espIPEl       = document.getElementById('espIP');
  const espUptimeEl   = document.getElementById('espUptime');
  const waterBar      = document.getElementById('waterLevelBar');
  const onBtn  = document.getElementById('onBtn');
  const offBtn = document.getElementById('offBtn');

  // Motor button colors
  function updateButtonColors(status) {
    motorStatusEl.innerText = status;
    if (status === 'ON') {
      onBtn.style.background = 'limegreen';
      offBtn.style.background = 'gray';
    } else if (status === 'OFF') {
      offBtn.style.background = 'tomato';
      onBtn.style.background = 'gray';
    }
  }

  // Send motor command
  function sendCommand(cmd) {
    if (client.connected) client.publish('motor/control', cmd);
  }

  // Reset ESP
  function resetESP() {
    if (client.connected && confirm("Reset ESP?")) {
      client.publish('esp/reset', 'RESET'); // must match ESP code
    }
  }

  // MQTT events
  client.on('connect', () => {
    mqttStatusEl.innerText = 'Connected';
    mqttStatusEl.style.color = 'limegreen';

    client.subscribe([
      'motor/status',
      'esp/status',
      'esp/ip',
      'esp/uptime',
      'sensor/waterLevel'
    ]);
  });

  client.on('reconnect', () => {
    mqttStatusEl.innerText = 'Reconnecting...';
    mqttStatusEl.style.color = 'orange';
  });

  client.on('offline', () => {
    mqttStatusEl.innerText = 'Offline';
    mqttStatusEl.style.color = 'red';
  });

  client.on('error', () => {
    mqttStatusEl.innerText = 'Error';
    mqttStatusEl.style.color = 'red';
  });

  // MQTT message handling
  client.on('message', (topic, message) => {
    const msg = message.toString();

    if (topic === 'motor/status') updateButtonColors(msg);

    if (topic === 'esp/status') {
      espStatusEl.innerText = msg;
      espStatusEl.className = (msg === 'ONLINE') ? 'online' : 'offline';
    }

    if (topic === 'esp/ip') espIPEl.innerText = msg;

    if (topic === 'esp/uptime') espUptimeEl.innerText = msg;

    if (topic === 'sensor/waterLevel') {
      let level = parseInt(msg);
      if (level < 0) level = 0;
      if (level > 100) level = 100;
      waterBar.style.width = level + '%';
      waterBar.innerText = level + '%';
    }
  });
</script>

</body>
</html>
