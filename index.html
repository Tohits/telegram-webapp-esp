<!DOCTYPE html>
<html>
<head>
  <title>MQTT Motor Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
</head>
<body>
  <h2>Motor Control Panel</h2>
  <button onclick="sendCommand('forward')">Forward</button>
  <button onclick="sendCommand('backward')">Backward</button>
  <button onclick="sendCommand('stop')">Stop</button>
  <p id="status">Connecting to MQTT...</p>

  <script>
    const broker = "broker.hivemq.com";
    const port = 8884;   // Secure WebSocket port
    const topic = "tohid/motor";

    let client = new Paho.MQTT.Client(broker, port, "webClient-" + Math.random());

    client.onConnectionLost = (responseObject) => {
      document.getElementById("status").innerText = "Connection lost: " + responseObject.errorMessage;
      // Auto reconnect after 3s
      setTimeout(connectMQTT, 3000);
    };

    client.onMessageArrived = (message) => {
      document.getElementById("status").innerText = "Received: " + message.payloadString;
    };

    function connectMQTT() {
      client.connect({
        useSSL: true,
        timeout: 5,
        keepAliveInterval: 30,   // ✅ keep connection alive
        cleanSession: true,
        onSuccess: () => {
          document.getElementById("status").innerText = "Connected to MQTT";
          client.subscribe(topic, {qos: 1});  // ✅ subscribe with QoS 1
        },
        onFailure: (err) => {
          document.getElementById("status").innerText = "Failed to connect: " + JSON.stringify(err);
          // Retry
          setTimeout(connectMQTT, 3000);
        }
      });
    }

    connectMQTT();

    function sendCommand(cmd) {
      if (client.isConnected()) {
        let message = new Paho.MQTT.Message(cmd);
        message.destinationName = topic;
        message.qos = 1;   // ✅ reliable delivery
        client.send(message);
        document.getElementById("status").innerText = "Sent: " + cmd;
      } else {
        document.getElementById("status").innerText = "Not connected!";
      }
    }
  </script>
</body>
</html>
