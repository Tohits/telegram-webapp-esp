<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Motor Position Control</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 520px; margin: 24px auto; }
    .card { padding:16px; border:1px solid #eee; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.06); }
    .row { display:flex; align-items:center; gap:12px; }
    .big { font-size: 1.25rem; }
    input[type=range]{ width:100%; }
    .status { margin-top:8px; opacity:.8; }
  </style>
</head>
<body>
  <h2>Motor Position Control (MQTT)</h2>
  <div class="card">
    <div class="row">
      <input id="slider" type="range" min="0" max="100" value="0" oninput="onSlide(this.value)" />
      <div class="big"><span id="pct">0</span>%</div>
    </div>
    <button onclick="send()">Send Target</button>
    <div class="status">
      Broker: <span id="conn">Connecting…</span><br/>
      State: <span id="state">—</span><br/>
      Live position: <span id="live">—</span>%<br/>
      Rain sensor: <span id="rain">—</span><br/>
      Water Level: <span id="waterLevel">—</span>%
    </div>
  </div>

  <script>
    // --- HiveMQ WebSocket config ---
    const url = "wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt";
    const options = {
      username: "tohits",
      password: "toh123@TOH",
      clean: true,
      connectTimeout: 5000,
      reconnectPeriod: 3000,
      clientId: "web_" + Math.random().toString(16).slice(2, 10),
    };

    // MQTT Topics
    const TOPIC_TARGET     = "motor/targetPercent";
    const TOPIC_PERCENT    = "motor/percent";
    const TOPIC_STATE      = "motor/state";
    const TOPIC_RAIN       = "sensor/rain";
    const TOPIC_WATERLEVEL = "sensor/waterLevel";  // added water level topic

    const client = mqtt.connect(url, options);

    client.on("connect", () => {
      document.getElementById("conn").innerText = "Connected";
      client.subscribe([TOPIC_PERCENT, TOPIC_STATE, TOPIC_RAIN, TOPIC_WATERLEVEL]);
    });

    client.on("reconnect", () => {
      document.getElementById("conn").innerText = "Reconnecting…";
    });

    client.on("error", (e) => {
      document.getElementById("conn").innerText = "Error";
      console.error(e);
    });

    client.on("message", (topic, payload) => {
      const msg = payload.toString();
      if (topic === TOPIC_PERCENT) {
        document.getElementById("live").innerText = msg;
      } else if (topic === TOPIC_STATE) {
        document.getElementById("state").innerText = msg;
      } else if (topic === TOPIC_RAIN) {
        document.getElementById("rain").innerText = msg === "1" ? "Raining" : "Clear";
      } else if (topic === TOPIC_WATERLEVEL) {
        document.getElementById("waterLevel").innerText = msg;
      }
    });

    let target = 0;
    function onSlide(val) {
      target = parseInt(val, 10);
      document.getElementById("pct").innerText = target;
    }

    function send() {
      client.publish(TOPIC_TARGET, String(target));
    }
  </script>
</body>
</html>
