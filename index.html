<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3-Phase Motor Control with MQTT</title>

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f9;
    color: #333;
  }
  h2 {
    margin-top: 30px;
  }
  p {
    font-size: 20px;
  }
  button {
    width: 170px;
    height: 65px;
    font-size: 22px;
    margin: 10px;
    border: none;
    border-radius: 15px;
    color: white;
    cursor: pointer;
    box-shadow: 0 5px #666;
    transition: 0.2s;
  }
  button:active {
    box-shadow: 0 2px #666;
    transform: translateY(4px);
  }

  #onBtn { background: gray; }
  #offBtn { background: gray; }
  #resetBtn { background: #444; }

  .online { color: limegreen; font-weight: bold; }
  .offline { color: red; font-weight: bold; }
</style>
</head>

<body>

<h2>3-Phase Motor Control</h2>

<p>Motor Status: <b id="motorStatus">--</b></p>
<button id="onBtn" onclick="sendCommand('ON')">ON</button>
<button id="offBtn" onclick="sendCommand('OFF')">OFF</button>

<hr>

<p>ESP Status: <span id="espStatus" class="offline">OFFLINE</span></p>
<p>ESP IP: <b id="espIP">--</b></p>
<p>ESP Uptime: <b id="espUptime">--</b> sec</p>

<button id="resetBtn" onclick="resetESP()">RESET ESP</button>

<p>MQTT Status: <span id="mqttStatus">Disconnected</span></p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  // ---------------- MQTT SETUP ----------------
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';

  const options = {
    username: 'tohits',
    password: 'toh123@TOH',
    reconnectPeriod: 1000,
    clean: true,
    connectTimeout: 4000,
  };

  const client = mqtt.connect(broker, options);

  // ---------------- ELEMENTS ----------------
  const motorStatusEl = document.getElementById('motorStatus');
  const mqttStatusEl  = document.getElementById('mqttStatus');
  const espStatusEl   = document.getElementById('espStatus');
  const espIPEl       = document.getElementById('espIP');
  const espUptimeEl  = document.getElementById('espUptime');
  const onBtn  = document.getElementById('onBtn');
  const offBtn = document.getElementById('offBtn');

  // ---------------- MOTOR UI ----------------
  function updateButtonColors(status) {
    motorStatusEl.innerText = status;

    if (status === 'ON') {
      onBtn.style.background = 'limegreen';
      offBtn.style.background = 'gray';
    } else if (status === 'OFF') {
      offBtn.style.background = 'tomato';
      onBtn.style.background = 'gray';
    } else {
      onBtn.style.background = 'gray';
      offBtn.style.background = 'gray';
    }
  }

  function sendCommand(cmd) {
    if (client.connected) {
      client.publish('motor/control', cmd);
    } else {
      alert('MQTT is not connected!');
    }
  }

  // ---------------- ESP RESET ----------------
  function resetESP() {
    if (client.connected) {
      if (confirm("Reset ESP device?")) {
        client.publish('esp/reset', '1');
      }
    } else {
      alert("MQTT not connected");
    }
  }

  // ---------------- MQTT EVENTS ----------------
  client.on('connect', () => {
    mqttStatusEl.innerText = 'Connected';
    mqttStatusEl.style.color = 'limegreen';

    client.subscribe([
      'motor/status',
      'esp/status',
      'esp/ip',
      'esp/uptime'
    ]);
  });

  client.on('reconnect', () => {
    mqttStatusEl.innerText = 'Reconnecting...';
    mqttStatusEl.style.color = 'orange';
  });

  client.on('offline', () => {
    mqttStatusEl.innerText = 'Offline';
    mqttStatusEl.style.color = 'red';
  });

  client.on('error', () => {
    mqttStatusEl.innerText = 'Error';
    mqttStatusEl.style.color = 'red';
  });

  // ---------------- MQTT MESSAGES ----------------
  client.on('message', (topic, message) => {
    const msg = message.toString();

    if (topic === 'motor/status') {
      updateButtonColors(msg);
    }

    if (topic === 'esp/status') {
      if (msg === 'ONLINE') {
        espStatusEl.innerText = 'ONLINE';
        espStatusEl.className = 'online';
      } else {
        espStatusEl.innerText = 'OFFLINE';
        espStatusEl.className = 'offline';
      }
    }

    if (topic === 'esp/ip') {
      espIPEl.innerText = msg;
    }

    if (topic === 'esp/uptime') {
      espUptimeEl.innerText = msg;
    }
  });
</script>

</body>
</html>
