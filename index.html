<!DOCTYPE html>
<html>
<head>
  <title>Motor Control via MQTT</title>
  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
</head>
<body>
  <h2>Motor Control</h2>

  <button onclick="sendCommand('forward')">Forward</button>
  <button onclick="sendCommand('backward')">Backward</button>
  <button onclick="sendCommand('stop')">Stop</button>

  <p id="status">Status: Not connected</p>

  <script>
    // MQTT broker
    const broker = "broker.hivemq.com";
    const port = 8000; // WebSocket port

    // Topics
    const topic = "tohid/motor";
    const statusTopic = "tohid/motor/status";

    // Create client
    const clientID = "webclient_" + parseInt(Math.random() * 100, 10);
    const client = new Paho.MQTT.Client(broker, port, clientID);

    // Connect
    client.connect({
      onSuccess: function () {
        console.log("Connected to broker");
        document.getElementById("status").innerText = "Connected to broker";
        client.subscribe(topic, { qos: 1 });
        client.subscribe(statusTopic, { qos: 1 });
      },
      onFailure: function (err) {
        console.log("Failed to connect:", err);
        document.getElementById("status").innerText = "Failed to connect";
      }
    });

    // Connection lost
    client.onConnectionLost = function (responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("Connection lost:", responseObject.errorMessage);
        document.getElementById("status").innerText = "Connection lost";
      }
    };

    // Handle incoming messages
    client.onMessageArrived = function (message) {
      console.log("Message arrived: " + message.payloadString);

      if (message.destinationName === statusTopic) {
        document.getElementById("status").innerText =
          "ESP says: " + message.payloadString;
      }
    };

    // Send commands
    function sendCommand(cmd) {
      const message = new Paho.MQTT.Message(cmd);
      message.destinationName = topic;
      client.send(message);
      console.log("Sent: " + cmd);
    }
  </script>
</body>
</html>
