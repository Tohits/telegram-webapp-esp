<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3-Phase Motor Control with MQTT</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f9;
    color: #333;
  }
  h2 {
    margin-top: 30px;
  }
  p {
    font-size: 22px;
  }
  button {
    width: 160px;
    height: 70px;
    font-size: 22px;
    margin: 15px;
    border: none;
    border-radius: 15px;
    color: white;
    cursor: pointer;
    box-shadow: 0 5px #666;
    transition: 0.2s;
  }
  button:active {
    box-shadow: 0 2px #666;
    transform: translateY(4px);
  }
  #onBtn { background: gray; }
  #offBtn { background: gray; }

  #mqttStatus {
    font-weight: bold;
    font-size: 20px;
  }
</style>
</head>
<body>

<h2>3-Phase Motor Control</h2>

<p>Motor Status: <b id="motorStatus">OFF</b></p>
<button id="onBtn" onclick="sendCommand('ON')">ON</button>
<button id="offBtn" onclick="sendCommand('OFF')">OFF</button>

<p>MQTT Status: <span id="mqttStatus">Disconnected</span></p>

<!-- ✅ ADDED: ESP WiFi Status -->
<p>ESP WiFi Status: <b id="espStatus">Unknown</b></p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  // HiveMQ Cloud MQTT broker WSS URL
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';

  // MQTT connection options
  const options = {
    username: 'tohits',
    password: 'toh123@TOH',
    reconnectPeriod: 1000,
    clean: true,
    connectTimeout: 4000,
  };

  // Connect client
  const client = mqtt.connect(broker, options);

  const motorStatusEl = document.getElementById('motorStatus');
  const mqttStatusEl = document.getElementById('mqttStatus');
  const espStatusEl  = document.getElementById('espStatus');
  const onBtn = document.getElementById('onBtn');
  const offBtn = document.getElementById('offBtn');

  // Update buttons color based on motor status
  function updateButtonColors(status) {
    if(status === 'ON') {
      motorStatusEl.innerText = 'ON';
      onBtn.style.background = 'limegreen';
      offBtn.style.background = 'gray';
    } else if(status === 'OFF') {
      motorStatusEl.innerText = 'OFF';
      offBtn.style.background = 'tomato';
      onBtn.style.background = 'gray';
    } else {
      motorStatusEl.innerText = status;
      onBtn.style.background = 'gray';
      offBtn.style.background = 'gray';
    }
  }

  // Send motor control command
  function sendCommand(cmd) {
    if(client.connected) {
      client.publish('motor/control', cmd);
    } else {
      alert('MQTT is not connected!');
    }
  }

  // MQTT event handlers
  client.on('connect', () => {
    mqttStatusEl.innerText = 'Connected';
    mqttStatusEl.style.color = 'limegreen';

    // Subscribe to topics
    client.subscribe('motor/status');
    client.subscribe('esp/status'); // ✅ ADDED
  });

  client.on('reconnect', () => {
    mqttStatusEl.innerText = 'Reconnecting...';
    mqttStatusEl.style.color = 'orange';
  });

  client.on('error', (error) => {
    mqttStatusEl.innerText = 'Error';
    mqttStatusEl.style.color = 'red';
    console.error('MQTT Error:', error);
  });

  client.on('offline', () => {
    mqttStatusEl.innerText = 'Offline';
    mqttStatusEl.style.color = 'red';
  });

  client.on('close', () => {
    mqttStatusEl.innerText = 'Disconnected';
    mqttStatusEl.style.color = 'red';
  });

  // Message received from broker
  client.on('message', (topic, message) => {
    if(topic === 'motor/status') {
      const status = message.toString();
      updateButtonColors(status);
    }

    // ✅ ADDED: ESP WiFi status handler
    if(topic === 'esp/status') {
      const status = message.toString();
      if(status === 'ONLINE') {
        espStatusEl.innerText = 'Connected';
        espStatusEl.style.color = 'limegreen';
      } else {
        espStatusEl.innerText = 'Disconnected';
        espStatusEl.style.color = 'red';
      }
    }
  });

</script>

</body>
</html>
